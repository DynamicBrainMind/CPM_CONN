extract_CONN_atlas_FC(atlas,sublist,conn_dir,dataset)

% Extract functional connectivity matrices from an atlas within a CONN project
% INPUTS:
% atlas (required)      : name of atlas within CONN project (e.g.'Schaefer300')
% sublist (required)    : cell array with folders names of all subjects included in CONN project
% conn_dir (required)   : full path to Conn project directory
% dataset (required)    : name of dataset folder name
% OUTPUTS:
% within Extracted_ts_Conn subfolder for each subject: FC matrices
% within dataset/Group folder: saves .mat file with 3D matrix (node x node x subject) r; also saves vector of FD (head motion)

%% Settings
global globalDataDir; % this must be set within startup.m
datapath=[globalDataDir];

% make output directories
for i=1:length(sublist)
    mkdir([datapath filesep dataset filesep sublist{i} filesep 'Extracted_ts_Conn']); 
end
mkdir([datapath filesep dataset filesep 'Group']); 

% load conn project file
a=strfind(conn_dir,filesep);
pre_conn_dir=conn_dir(1:a(end));
post_conn_dir=conn_dir(a(end)+1:length(conn_dir));
load([pre_conn_dir post_conn_dir '.mat']);

% extract time series
for i=1:length(sublist)
    for j=1:1
    atlas_ts=[];
    clear data data_sessions xyz roi_files
    % find all subject files
    roi_files=dir([conn_dir filesep 'results' filesep 'preprocessing' filesep '*Condition000.mat']);
    load([conn_dir filesep 'results' filesep 'preprocessing' filesep roi_files(i).name]);
        for k=1:length(data) % find atlas ROIs
            if contains(names{k},atlas)
               atlas_ts=[atlas_ts data{k}]; 
            end
        end
        
    % extract FD (Jenkinson)
    b=[];
    FD_dir=CONN_x.Setup.functional{1,i}{1,1}{1,3}.fname;   
    b=strfind(FD_dir,filesep);
    fd_dir=FD_dir(1:b(end));
    fd=dir([fd_dir  '*FDjenkinson*']);
    fd=load([fd_dir fd.name]); 
    fd=fd.R;
    mean_FD=mean(fd(2:end)); mean_FD=mean_FD';

    % save    
    save('mean_FD','mean_FD');
    save([atlas '.txt'],'atlas_ts','-ascii');   
    save([atlas '_first_3min.txt'],'first_3min','-ascii'); 
    save([atlas '_second_3min.txt'],'second_3min','-ascii'); 
    display(['Done subject ' num2str(i) ' run ' num2str(j)]);
    end
end
